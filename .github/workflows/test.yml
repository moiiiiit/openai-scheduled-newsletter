name: Run Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry virtualenv
        uses: actions/cache@v3
        with:
          path: openai_scheduled_newsletter_api/.venv
          key: poetry-api-${{ hashFiles('openai_scheduled_newsletter_api/poetry.lock') }}

      - name: Install API dependencies (with dev)
        run: cd openai_scheduled_newsletter_api && poetry install --with dev

      - name: Run API tests
        run: cd openai_scheduled_newsletter_api && poetry run python -m pytest -v tests/

  test-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry virtualenv
        uses: actions/cache@v3
        with:
          path: openai_scheduled_newsletter_job/.venv
          key: poetry-job-${{ hashFiles('openai_scheduled_newsletter_job/poetry.lock') }}

      - name: Install Job dependencies (with dev)
        run: cd openai_scheduled_newsletter_job && poetry install --with dev

      - name: Run Job tests
        run: cd openai_scheduled_newsletter_job && poetry run python -m pytest -v tests/
